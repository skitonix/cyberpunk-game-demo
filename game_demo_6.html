<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NeonGrid — Stable Build + Offices</title>
  <style>
    :root{--bg:#0a0c10;--panel:#0e1117;--panel2:#0b0e13;--text:#e2e8f0;--muted:#94a3b8;--neon:#00f0ff;--neon2:#ff00e6;--hp:#ff3b3b;--food:#ffd166;--drink:#60a5fa;--xp:#22c55e;--money:#a3e635}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;background:radial-gradient(1200px 800px at 20% -10%, rgba(0,240,255,.12), transparent),radial-gradient(900px 700px at 120% 120%, rgba(255,0,230,.10), transparent),var(--bg);color:var(--text);font-family:ui-monospace,Menlo,Consolas,monospace}
    .app{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;padding:16px;height:100%}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #1f2937;border-radius:14px;box-shadow:0 0 0 1px rgba(0,240,255,.06),0 20px 60px rgba(0,0,0,.35);overflow:hidden}
    .header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #1f2937;background:linear-gradient(90deg,rgba(0,240,255,.07),transparent 40%, rgba(255,0,230,.07))}
    .header .title{font-weight:700;text-transform:uppercase;letter-spacing:.12em}
    .hud{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;padding:10px;background:linear-gradient(180deg,rgba(0,240,255,.06),transparent);border-bottom:1px dashed #1f2937}
    .bar{display:grid;gap:6px}.bar label{font-size:.72rem;color:var(--muted)}.bar .track{height:10px;background:#0b1220;border:1px solid #1f2937;border-radius:999px;overflow:hidden;box-shadow:inset 0 0 12px rgba(0,0,0,.6)}.bar .fill{height:100%}
    .fill.hp{background:linear-gradient(90deg,#ff3b3b,#ff7a7a)}.fill.food{background:linear-gradient(90deg,#ffd166,#f59e0b)}.fill.drink{background:linear-gradient(90deg,#60a5fa,#22d3ee)}.fill.xp{background:linear-gradient(90deg,#22c55e,#86efac)}.fill.money{background:linear-gradient(90deg,#a3e635,#bef264)}
    .statline{display:flex;gap:8px;align-items:center;font-size:.8rem;color:var(--muted)}
    .left{display:grid;grid-template-rows:auto 1fr;gap:12px}.right{display:grid;grid-template-rows:auto auto 1fr auto;gap:12px}
    .mapwrap{display:grid;grid-template-rows:auto 1fr}.maparea{padding:14px;display:flex;justify-content:center}
    .asciimap{display:inline-block;border:1px solid #1f2937;border-radius:12px;padding:16px;overflow:auto;background:#0a1018}
    .row{height:24px;white-space:nowrap}
    .cell{display:inline-block;width:16px;height:20px;margin:2px 0;text-align:center;cursor:default;user-select:none}
    .cell.player{color:var(--neon2);text-shadow:0 0 8px rgba(255,0,230,.6),0 0 18px rgba(255,0,230,.35)}
    .cell.wall{color:#334155}.cell.road{color:#64748b}.cell.shop{color:#a3e635}.cell.job{color:#22d3ee}.cell.rest{color:#f472b6}.cell.house{color:#fbbf24}.cell.fence{color:#22c55e}.cell.wh{color:#93c5fd}.cell.weapon{color:#fca5a5}.cell.car{color:#a78bfa}.cell.gas{color:#60a5fa}.cell.repair{color:#94a3b8}.cell.gate{color:#36f9a3}.cell.station{color:#22c55e}.cell.office{color:#38bdf8}
    .soft{color:var(--muted)}.console{padding:12px 14px;font-size:.9rem;height:100%;overflow:auto}
    .logline{opacity:.95;margin:.25rem 0}.logline .tm{color:#64748b;margin-right:.5rem}
    .logline.ok{color:#a7f3d0}.logline.warn{color:#fde68a}.logline.bad{color:#fecaca}
    .actions{padding:12px;display:grid;gap:10px}
    .btn{background:#0e1624;border:1px solid #334155;padding:10px 12px;border-radius:10px;cursor:pointer;color:var(--text);box-shadow:0 0 0 1px rgba(0,240,255,.08)}.btn:hover{border-color:#3b82f6;box-shadow:0 0 0 1px rgba(0,240,255,.18)}
    .drawer{display:grid;grid-template-rows:auto 1fr auto}.drawer .content{padding:12px 14px;overflow:auto}.drawer h3{margin:.2rem 0 .5rem;letter-spacing:.08em;text-transform:uppercase;font-size:.9rem;color:#93c5fd}
    .list{display:grid;gap:8px}.item{border:1px solid #1f2937;background:#0b1220;border-radius:10px;padding:10px}.item .meta{font-size:.82rem;color:var(--muted)}.item .row{display:flex;justify-content:space-between;align-items:center}
    .footer{padding:10px 14px;border-top:1px solid #1f2937;display:flex;gap:8px;justify-content:space-between;align-items:center;font-size:.85rem;color:var(--muted)}
    .menu-card .section{padding:12px 14px}.glow{color:var(--neon);text-shadow:0 0 8px rgba(0,240,255,.75),0 0 18px rgba(0,240,255,.35)}
  </style>
</head>
<body>
  <div class="app">
    <section class="left">
      <div class="card mapwrap">
        <div class="header">
          <div class="title glow">game </div>
          <div class="statline"><span id="clock">00:00</span> · <span id="day">Day 1</span> · <span id="sector">Sector A</span></div>
        </div>
        <div class="hud">
          <div class="bar"><label>HP</label><div class="track"><div id="hpFill" class="fill hp"></div></div><div class="statline"><span id="hpVal">100</span>/100</div></div>
          <div class="bar"><label>FOOD</label><div class="track"><div id="foodFill" class="fill food"></div></div><div class="statline"><span id="foodVal">60</span>/100</div></div>
          <div class="bar"><label>DRINK</label><div class="track"><div id="drinkFill" class="fill drink"></div></div><div class="statline"><span id="drinkVal">60</span>/100</div></div>
          <div class="bar"><label>XP</label><div class="track"><div id="xpFill" class="fill xp"></div></div><div class="statline"><span id="xpVal">0</span>/100</div></div>
          <div class="bar"><label>₿</label><div class="track"><div id="moneyFill" class="fill money"></div></div><div class="statline"><span id="moneyVal">250</span> cr</div></div>
        </div>
        <div class="maparea"><div id="map" class="asciimap"></div></div>
        <div class="legend">
          <span class="pill" style="color:var(--neon2)">▲ You</span>
          <span class="pill" style="color:var(--xp)">J Job</span>
          <span class="pill" style="color:var(--money)">S Shop</span>
          <span class="pill" style="color:#f472b6">R Restaurant</span>
          <span class="pill" style="color:#fbbf24">H House</span>
          <span class="pill" style="color:#fb5d24">H your House</span>
          <span class="pill" style="color:#93c5fd">W Warehouse</span>
          <span class="pill" style="color:#fca5a5">W Weapons</span>
          <span class="pill" style="color:#a78bfa">C Car Dealer</span>
          <span class="pill" style="color:#60a5fa">G Gas</span>
          <span class="pill" style="color:#94a3b8">M Repair</span>
          <span class="pill" style="color:#36f9a3">G Gate</span>
          <span class="pill" style="color:#22c55e">R run down gate</span>
          <span class="pill" style="color:#38bdf8">O Office</span>
        </div>
      </div>

      <div class="card">
        <div class="header"><div class="title">TERMINAL</div></div>
        <div id="log" class="console"></div>
      </div>
    </section>

    <section class="right">
      <div class="card drawer">
        <div class="header"><div class="title">LOCATION</div><div id="locName" class="soft">—</div></div>
        <div class="content">
          <h3>Actions</h3>
          <div id="locActions" class="list"></div>
          <h3>Details</h3>
          <div id="locDetails" class="list"></div>
        </div>
        <div class="footer">
          <div>Travel: <span id="travelCost" class="soft">—</span></div>
          <div style="display:flex;gap:8px">
            <button class="btn" id="btnWalk">Walk</button>
            <button class="btn" id="btnTaxi">Taxi</button>
            <button class="btn" id="btnDrive">Drive</button>
          </div>
        </div>
      </div>

      <div class="card menu-card">
        <div class="header"><div class="title">MENU</div><div class="soft">Systems</div></div>
        <div class="section" style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnPhone">Phone</button>
          <button class="btn" id="btnCharacter">Character</button>
          <button class="btn" id="btnGarage">Garage</button>
        </div>
        <div class="section" id="menuPanel"></div>
      </div>

      <div class="card">
        <div class="header"><div class="title">quick menu</div><div class="soft">Inventory & Save</div></div>
        <div class="actions">
          <div class="row" style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" id="btnEat">Eat (−1 ration)</button>
            <button class="btn" id="btnDrink">Drink (−1 water)</button>
            <button class="btn" id="btnMed">Use Medkit</button>
            <button class="btn" id="btnSave">Save</button>
            <button class="btn" id="btnLoad">Load</button>
          </div>
        </div>
        <div class="footer"><div class="soft" id="invText">Inventory: rations 1, water 0, medkits 0</div></div>
      </div>
    </section>
  </div>

  <script>
  // ---------- SECTORS ----------
  const SECTORS = { A:{name:'Sector A', build: buildSectorA}, B:{name:'Sector B', build: buildSectorB} };
  let currentSector='A';

  // Map constants (SINGLE-CHAR TILES ONLY)
  const W=38,H=18;
  const TILES={WALL:'#',ROAD:'·',PLAYER:'▲',SHOP:'S',JOB:'J',REST:'R',HOUSE:'H',WH:'W',FENCE:'F',WEAPON:'W',CAR:'C',GAS:'G',REPAIR:'M',GATE:'|',STATION:'O',OFFICE:'Q'};

  function blankMap(){return Array.from({length:H},(_,y)=>Array.from({length:W},(_,x)=>({ch:TILES.WALL,type:'wall',x,y})));}
  function carveRoad(m,x1,y1,x2,y2){for(let y=Math.min(y1,y2);y<=Math.max(y1,y2);y++)m[y][x1]={ch:TILES.ROAD,type:'road',x:x1,y};for(let x=Math.min(x1,x2);x<=Math.max(x1,x2);x++)m[y2][x]={ch:TILES.ROAD,type:'road',x,y:y2};}
  function placePOI(m,p){m[p.y][p.x]={ch:p.ch,type:p.kind,x:p.x,y:p.y,name:p.name,desc:p.desc,sector:p.sector||currentSector};}

  function buildSectorA(){
    const m=blankMap();
    carveRoad(m,3,2,34,2);carveRoad(m,3,5,34,5);carveRoad(m,3,9,34,9);carveRoad(m,3,13,34,13);carveRoad(m,3,16,34,16);
    carveRoad(m,3,2,3,16);carveRoad(m,10,2,10,16);carveRoad(m,18,2,18,16);carveRoad(m,26,2,26,16);carveRoad(m,34,2,34,16);
    const P=[
      {x:3,y:2,ch:TILES.JOB,name:'server hub',kind:'job',desc:'A secure building filled with servers.'},
      {x:10,y:5,ch:TILES.SHOP,name:'Choomba depot',kind:'shop',desc:'a simple that sells Supplies and medkits.'},
      {x:18,y:9,ch:TILES.REST,name:'street food stand',kind:'restaurant',desc:'a simple food cart with a cooler next to it.'},
      {x:26,y:13,ch:TILES.JOB,name:'Courier Hub',kind:'job',desc:'a mail office (note-update this buildings code it sucks! and causes map to break).'},
      {x:34,y:5,ch:TILES.SHOP,name:'neon place (update later!)',kind:'shop',desc:'Street vendors & a fence.'},
      {x:10,y:13,ch:TILES.HOUSE,name:'small apartment (Home)',kind:'playerhouse',desc:'your home a small apartment that has the basics.'},
      {x:18,y:5,ch:TILES.HOUSE,name:'corpo hotel',kind:'house',desc:'a hotel.'},
      {x:26,y:9,ch:TILES.REST,name:'buck a slice',kind:'restaurant',desc:'fresh pizza.'},
      {x:34,y:13,ch:TILES.HOUSE,name:'Dockside Pods',kind:'house',desc:'Waterfront-ish.'},
      {x:6,y:5,ch:TILES.WH,name:'South Docks Warehouse',kind:'warehouse',desc:'Cargo staging.'},
      {x:34,y:9,ch:TILES.FENCE,name:'Shadow Fence',kind:'fence',desc:'Moves hot goods.'},
      {x:6,y:9,ch:TILES.WEAPON,name:'Street Steel',kind:'weapons',desc:'Blades & bolts.'},
      {x:22,y:5,ch:TILES.CAR,name:'Metro Motors',kind:'cardealer',desc:'Buy a ride.'},
      {x:30,y:5,ch:TILES.GAS,name:'FuelStop',kind:'gas',desc:'Top up fuel.'},
      {x:30,y:13,ch:TILES.REPAIR,name:'QuickFix',kind:'repair',desc:'Patch your ride.'},
      {x:0,y:9,ch:TILES.GATE,name:'Sector Gate West',kind:'gate',desc:'Secure checkpoint to Sector B.'},
      {x:0,y:5,ch:TILES.STATION,name:'Old Station W',kind:'station',desc:'Shutdown station: start generator & hack AV.'},
      {x:22,y:9,ch:TILES.OFFICE,name:'OmniCorp Tower',kind:'office',desc:'Corporate office complex.'}
    ];
    P.forEach(p=>placePOI(m,p));
    return m;
  }
  function buildSectorB(){
    const m=blankMap();
    carveRoad(m,3,2,34,2);carveRoad(m,3,6,34,6);carveRoad(m,3,10,34,10);carveRoad(m,3,14,34,14);
    carveRoad(m,3,2,3,16);carveRoad(m,14,2,14,16);carveRoad(m,24,2,24,16);carveRoad(m,34,2,34,16);
    const P=[
      {x:6,y:6,ch:TILES.WH,name:'North Stack Warehouse',kind:'warehouse',desc:'Cold storage.'},
      {x:14,y:10,ch:TILES.CAR,name:'Luxury Motors',kind:'cardealer',desc:'Expensive cars.'},
      {x:24,y:6,ch:TILES.WEAPON,name:'Armory Nine',kind:'weapons',desc:'Heavy pieces.'},
      {x:30,y:10,ch:TILES.GAS,name:'NeonGas',kind:'gas',desc:'Open all night.'},
      {x:20,y:14,ch:TILES.REPAIR,name:'ProRepair',kind:'repair',desc:'Certified techs.'},
      {x:34,y:9,ch:TILES.GATE,name:'Sector Gate East',kind:'gate',desc:'Secure checkpoint to Sector A.'},
      {x:34,y:5,ch:TILES.STATION,name:'Old Station E',kind:'station',desc:'Shutdown station.'},
      {x:10,y:10,ch:TILES.OFFICE,name:'NeoSys Offices',kind:'office',desc:'Tech company HQ.'}
    ];
    P.forEach(p=>placePOI(m,p));
    return m;
  }

  // Build initial map
  let map = SECTORS[currentSector].build();

  // ---------- STATE ----------
  const state={x:6,y:2,hp:100,food:60,drink:60,xp:0,money:250,minute:8*60,day:1,inv:{rations:1,water:0,medkit:0},gig:null,carriedCargo:false,stolen:false,vehicle:null};

  // ---------- RENDER ----------
  const mapEl=document.getElementById('map');
  const cls=c=> (c.type==='wall'?'wall': c.type==='road'?'road': c.type==='shop'?'shop': c.type==='job'?'job': c.type==='restaurant'?'rest': c.type==='warehouse'?'wh': c.type==='fence'?'fence': c.type==='weapons'?'weapon': c.type==='cardealer'?'car': c.type==='gas'?'gas': c.type==='repair'?'repair': c.type==='gate'?'gate': c.type==='station'?'station': c.type==='office'?'office': c.type.includes('house')?'house':'road') + ((c.x===state.x&&c.y===state.y)?' player':'');
  function renderMap(){ mapEl.innerHTML=''; for(let y=0;y<H;y++){ const row=document.createElement('div'); row.className='row'; for(let x=0;x<W;x++){ const c=map[y][x]; const sp=document.createElement('span'); sp.className='cell '+cls(c); sp.textContent=(x===state.x&&y===state.y)?TILES.PLAYER:c.ch; sp.addEventListener('click',()=>selectLocation(c)); row.appendChild(sp);} mapEl.appendChild(row);} document.getElementById('sector').textContent=SECTORS[currentSector].name; }

  // ---------- HUD ----------
  const hpFill=document.getElementById('hpFill'),foodFill=document.getElementById('foodFill'),drinkFill=document.getElementById('drinkFill'),xpFill=document.getElementById('xpFill'),moneyFill=document.getElementById('moneyFill');
  const hpVal=document.getElementById('hpVal'),foodVal=document.getElementById('foodVal'),drinkVal=document.getElementById('drinkVal'),xpVal=document.getElementById('xpVal'),moneyVal=document.getElementById('moneyVal');
  const clockEl=document.getElementById('clock'),dayEl=document.getElementById('day'),invText=document.getElementById('invText');
  function syncHUD(){ const clamp=v=>Math.max(0,Math.min(100,v)); hpVal.textContent=Math.round(state.hp); foodVal.textContent=Math.round(state.food); drinkVal.textContent=Math.round(state.drink); xpVal.textContent=Math.round(state.xp%100); moneyVal.textContent=Math.round(state.money); hpFill.style.width=clamp(state.hp)+'%'; foodFill.style.width=clamp(state.food)+'%'; drinkFill.style.width=clamp(state.drink)+'%'; xpFill.style.width=clamp(state.xp%100)+'%'; moneyFill.style.width=Math.min(100,state.money/10)+'%'; const h=Math.floor(state.minute/60)%24,m=state.minute%60; clockEl.textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; dayEl.textContent=`Day ${state.day}`; invText.textContent=`Inventory: rations ${state.inv.rations}, water ${state.inv.water||0}, medkits ${state.inv.medkit||0}`; }

  // ---------- LOG ----------
  const logEl=document.getElementById('log'); function log(msg,l='ok'){ const d=document.createElement('div'); d.className=`logline ${l}`; const tm=document.createElement('span'); tm.className='tm'; tm.textContent=`[${clockEl.textContent}]`; d.appendChild(tm); d.append(msg); logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }

  // ---------- LOCATION PANEL ----------
  const locName=document.getElementById('locName'),locActions=document.getElementById('locActions'),locDetails=document.getElementById('locDetails');
  const travelCostEl=document.getElementById('travelCost');
  const btnWalk=document.getElementById('btnWalk'),btnTaxi=document.getElementById('btnTaxi'),btnDrive=document.getElementById('btnDrive');
  let selected=null;

  function selectLocation(c){
    selected=c; locName.textContent=(c.name?`${c.name} — ${cellTypeName(c.type)}`:`Tile (${c.x},${c.y})`); locActions.innerHTML=''; locDetails.innerHTML='';
    const dist=Math.abs(state.x-c.x)+Math.abs(state.y-c.y); const taxiCost=Math.max(0,dist-2); travelCostEl.textContent=`${dist}m walk · ${taxiCost} cr taxi`;
    const d=document.createElement('div'); d.className='item'; d.innerHTML=`<div class="meta">${c.desc||'No special features.'}</div>`; locDetails.appendChild(d);

    if(c.type==='shop') buildShopActions();
    if(c.type==='restaurant') buildRestaurantActions();
    if(c.type==='job') buildJobActions();
    if(c.type==='house' || c.type==='playerhouse') buildHouseActions(c.type==='playerhouse');
    if(c.type==='warehouse') buildWarehouseActions(c);
    if(c.type==='fence') buildFenceActions();
    if(c.type==='weapons') buildWeaponActions();
    if(c.type==='cardealer') buildCarDealerActions();
    if(c.type==='gas') buildGasActions();
    if(c.type==='repair') buildRepairActions();
    if(c.type==='gate') buildGateActions();
    if(c.type==='station') buildStationActions();
    if(c.type==='office') buildOfficeActions();

    maybeShowGigDelivery(c);

    btnWalk.onclick=()=>travelTo(c,dist,'walk',taxiCost);
    btnTaxi.onclick=()=>travelTo(c,dist,'taxi',taxiCost);
    btnDrive.onclick=()=>travelTo(c,dist,'drive',taxiCost);
  }

  const cellTypeName=t=>({shop:'Shop',job:'Job Board',restaurant:'Restaurant',house:'House',playerhouse:'Your Home',warehouse:'Warehouse',fence:'Fence',weapons:'Weapons',cardealer:'Car Dealer',gas:'Gas',repair:'Repair Shop',gate:'Sector Gate',station:'Old Station',office:'Office'})[t]||'Tile';
  function addAction(name,meta,handler){ const it=document.createElement('div'); it.className='item'; it.innerHTML=`<div class="row"><div>${name}</div><button class="btn">Do</button></div><div class="meta">${meta}</div>`; it.querySelector('button').addEventListener('click',handler); locActions.appendChild(it); }

  function buildShopActions(){ addAction('Buy Ration','Restores +25 FOOD · 20 cr',()=>buy('rations',20)); addAction('Buy Water','Restores +25 DRINK · 15 cr',()=>buy('water',15)); addAction('Buy Medkit','Heals +35 HP · 60 cr',()=>buy('medkit',60)); }
  function buildRestaurantActions(){ addAction('Eat Meal','+40 FOOD, +5 DRINK · −35 cr, 20m',()=>{ if(spend(35)){ advanceTime(20); addFood(40); addDrink(5); log('You ate a meal.'); syncHUD(); }}); addAction('Drink Hydra‑Soda','+35 DRINK · −18 cr, 5m',()=>{ if(spend(18)){ advanceTime(5); addDrink(35); log('You down a Hydra‑Soda.'); syncHUD(); }}); }
  function buildJobActions(){ addAction('Data‑scrape','+45 cr, +12 XP, −10 DRINK, 40m',()=>{ advanceTime(40); state.money+=45; state.xp+=12; addDrink(-10); fatigue(5); log('Completed a data‑scrape. +45 cr, +12 XP'); syncHUD();}); addAction('Courier Run','+75 cr, +20 XP, −15 FOOD, −15 DRINK, 90m',()=>{ advanceTime(90); state.money+=75; state.xp+=20; addFood(-15); addDrink(-15); fatigue(10); log('You finished a courier run. +75 cr, +20 XP'); syncHUD();}); }
  function buildHouseActions(isHome){ addAction('Rest (1h)','+10 HP, +5 FOOD, +5 DRINK',()=>{ advanceTime(60); heal(10); addFood(5); addDrink(5); log('You rest for an hour.'); syncHUD();}); if(isHome){ addAction('Sleep (6h)','Restore FOOD/DRINK to 70, heal +25 HP',()=>{ advanceTime(360); heal(25); state.food=Math.max(state.food,70); state.drink=Math.max(state.drink,70); log('You crash at your capsule.'); syncHUD();}); } }
  function buildWarehouseActions(c){ if(state.gig && !state.carriedCargo && state.gig.pickup.x===c.x && state.gig.pickup.y===c.y && state.gig.sector===currentSector){ addAction('Pick up cargo','Load parcel for delivery',()=>{ state.carriedCargo=true; log('Cargo secured. Deliver to '+state.gig.drop.name); syncHUD(); }); addAction('Steal cargo','Mark as stolen and fence it later',()=>{ state.carriedCargo=true; state.stolen=true; log('You jacked the cargo. Find a fence.','warn'); syncHUD();}); } }
  function buildFenceActions(){ if(state.carriedCargo && state.stolen){ addAction('Sell stolen cargo','+120 cr, +10 XP',()=>{ state.carriedCargo=false; state.stolen=false; state.money+=120; state.xp+=10; state.gig=null; log('Sold stolen cargo to the fence.'); syncHUD(); menuPanel.innerHTML=''; }); } }
  function buildWeaponActions(){ addAction('Buy Knife','120 cr',()=>{ if(spend(120)){ state.inv.knife=(state.inv.knife||0)+1; log('Bought Knife'); syncHUD(); } }); addAction('Buy Pistol','420 cr',()=>{ if(spend(420)){ state.inv.pistol=(state.inv.pistol||0)+1; log('Bought Pistol'); syncHUD(); } }); }
  function buildCarDealerActions(){ addAction('Browse Cars','Different fuel use & reliability',()=> openGarage()); }
  function buildGasActions(){ addAction('Refuel','50 fuel · 40 cr',()=>{ if(!state.vehicle){ log('No vehicle','warn'); return;} if(spend(40)){ state.vehicle.fuel=Math.min(state.vehicle.fuelMax,state.vehicle.fuel+50); log('Refueled.'); syncHUD(); } }); }
  function buildRepairActions(){ addAction('Repair','+30 vehicle health · 60 cr',()=>{ if(!state.vehicle){ log('No vehicle','warn'); return;} if(spend(60)){ state.vehicle.health=Math.min(100,state.vehicle.health+30); log('Repaired.'); syncHUD(); } }); }
  function buildGateActions(){ addAction('Secure travel to other sector','Costs 200–400 cr',()=>{ const cost=200+Math.floor(Math.random()*201); if(state.money<cost){ log('Not enough credits for secure travel','warn'); return;} state.money-=cost; switchSector(currentSector==='A'?'B':'A'); log(`Secure checkpoint passed (−${cost} cr).`); syncHUD(); }); }
  function buildStationActions(){ addAction('Use Old Station','Start generator then hack AV',()=> startOldStation()); }

  // ---------- OFFICES ----------
  function buildOfficeActions(){
    if(state.xp>=10){ addAction('Office Worker','Requires 10 XP. Do any 3 tasks (Move File / Send Email) for 325 cr.',()=>startOfficeMini('office')); }
    else { addAction('Office Worker','Requires 10 XP.',()=>log('You need 10 XP to work Office.','warn')); }
    if(state.xp>=5){ addAction('IT Technician','Requires 5 XP. Do any 3 tasks (Plug Computer / Connect Wi‑Fi) for 150 cr.',()=>startOfficeMini('it')); }
    else { addAction('IT Technician','Requires 5 XP.',()=>log('You need 5 XP to work IT.','warn')); }
  }
  function startOfficeMini(role){
    const box=document.createElement('div'); box.className='item'; let done=0;
    function render(){
      box.innerHTML='';
      if(role==='office'){
        box.innerHTML+='<div><b>Office Worker</b> — complete 3 tasks</div>';
        ['Move File','Send Email'].forEach(t=>{ const b=document.createElement('button'); b.className='btn'; b.textContent=t; b.onclick=()=>{ done++; advanceTime(10); log('Admin task completed.'); if(done>=3) finishOfficeJob('office'); else render(); }; box.appendChild(b); });
      } else {
        box.innerHTML+='<div><b>IT Technician</b> — complete 3 tasks</div>';
        ['Plug Computer','Connect Wi‑Fi'].forEach(t=>{ const b=document.createElement('button'); b.className='btn'; b.textContent=t; b.onclick=()=>{ done++; advanceTime(10); log('IT task completed.'); if(done>=3) finishOfficeJob('it'); else render(); }; box.appendChild(b); });
      }
    }
    render(); locActions.innerHTML=''; locActions.appendChild(box);
  }
  function finishOfficeJob(role){ if(role==='office'){ state.money+=325; state.xp+=12; log('Office Worker shift: +325 cr, +12 XP'); } else { state.money+=150; state.xp+=8; log('IT Technician shift: +150 cr, +8 XP'); } syncHUD(); selectLocation(map[state.y][state.x]); }

  // ---------- Phone & Garage (unchanged aside from title)
  const menuPanel=document.getElementById('menuPanel');
  document.getElementById('btnPhone').onclick=()=> renderPhone();
  document.getElementById('btnCharacter').onclick=()=> renderChar();
  document.getElementById('btnGarage').onclick=()=> openGarage();
  function renderPhone(){ menuPanel.innerHTML=''; const list=document.createElement('div'); list.className='list'; const fixers=[ {name:'Vera Sparks', offer: offerGig('A',{x:6,y:5,name:'South Docks Warehouse'},{sector:'B',x:6,y:6,name:'North Stack Warehouse'},200,300)}, {name:'Mr. Obsidian', offer: offerGig('B',{sector:'B',x:6,y:6,name:'North Stack Warehouse'},{sector:'A',x:26,y:13,name:'Courier Hub'},260,420)} ]; fixers.forEach(f=>{ const it=document.createElement('div'); it.className='item'; it.innerHTML=`<div class="row"><div>Call ${f.name}</div><button class="btn">Dial</button></div><div class="meta">Request a cargo gig (may cross sectors).</div>`; it.querySelector('button').onclick=()=>{ state.gig=f.offer; log(`Fixer ${f.name} offered a gig: pick up at ${state.gig.pickup.name} (${state.gig.sector}) → deliver to ${state.gig.drop.name} (${state.gig.drop.sector}) for ${state.gig.pay} cr. Deadline ${state.gig.remaining}m.`); renderPhone(); }; list.appendChild(it); }); if(state.gig){ const g=document.createElement('div'); g.className='item'; g.innerHTML=`<div class="row"><div>Active Gig</div><div class="meta">${state.gig.pickup.name} (${state.gig.sector}) → ${state.gig.drop.name} (${state.gig.drop.sector}) · pay ${state.gig.pay} cr · ${state.gig.remaining}m left</div></div>`; list.appendChild(g); } menuPanel.appendChild(list); }
  function offerGig(pSector,pick,drop,pay,deadline){ return { sector:pSector, pickup:{x:pick.x,y:pick.y,name:pick.name}, drop:{x:drop.x,y:drop.y,name:drop.name,sector:drop.sector}, pay, deadline:true, remaining:deadline, dropSector:drop.sector }; }
  function renderChar(){ menuPanel.innerHTML=''; const box=document.createElement('div'); box.className='item'; box.innerHTML=`<div>Level: ${1+Math.floor(state.xp/100)} <span class="meta">(${state.xp%100}/100 XP)</span></div>`; menuPanel.appendChild(box); }
  function openGarage(){ menuPanel.innerHTML=''; const cars=[ {name:'Rust Runner',price:200,fuelPerTile:.8,quality:30,fuelMax:80}, {name:'Metro Cruiser',price:650,fuelPerTile:.5,quality:70,fuelMax:120}, {name:'Volt GT',price:1500,fuelPerTile:.35,quality:95,fuelMax:160} ]; cars.forEach(car=>{ const it=document.createElement('div'); it.className='item'; it.innerHTML=`<div class="row"><div>${car.name}</div><button class="btn">Buy</button></div><div class="meta">${car.price} cr · fuel/tile ${car.fuelPerTile} · quality ${car.quality}</div>`; it.querySelector('button').onclick=()=>{ if(!spend(car.price)){ log('Not enough credits.','warn'); return;} state.vehicle=Object.assign({},car,{fuel:car.fuelMax,health:100}); log(`Purchased ${car.name}.`); syncHUD(); openGarage(); }; menuPanel.appendChild(it); }); if(state.vehicle){ const it=document.createElement('div'); it.className='item'; it.innerHTML=`<div>Current vehicle: ${state.vehicle.name} <span class="meta">fuel ${state.vehicle.fuel}/${state.vehicle.fuelMax} · health ${state.vehicle.health}</span></div>`; menuPanel.appendChild(it); } }

  // ---------- TRAVEL ----------
  function travelTo(c,dist,mode='walk',taxiCost=0){ if(c.x===state.x&&c.y===state.y){ log('You are already here.','warn'); return; } if(mode==='taxi'){ if(state.money<taxiCost){ log('Not enough credits for taxi.','warn'); return;} state.money-=taxiCost; advanceTime(dist); moveTo(c,false,dist); const destName = c.name || ('('+c.x+','+c.y+')'); log(`Taxi to ${destName} (−${taxiCost} cr, ${dist}m).`); } else if(mode==='drive'){ if(!state.vehicle){ log('No vehicle.','warn'); return;} const fuelNeed=Math.ceil(dist*state.vehicle.fuelPerTile); if(state.vehicle.fuel<fuelNeed){ log('Not enough fuel.','warn'); return;} state.vehicle.fuel-=fuelNeed; const breakChance=Math.max(0.02,0.18 - state.vehicle.quality/150); if(Math.random()<breakChance){ state.vehicle.health=Math.max(0,state.vehicle.health-20); log('Your car coughed and lost some health.','warn'); } advanceTime(dist); moveTo(c,false,dist); const destName2 = c.name || ('('+c.x+','+c.y+')'); log(`Drove to ${destName2} (${dist}m, −${fuelNeed} fuel).`); } else { advanceTime(dist); moveTo(c,true,dist); const destName3 = c.name || ('('+c.x+','+c.y+')'); log(`Walked to ${destName3} (${dist}m).`); } }
  function moveTo(c,drain,dist){ const dx=Math.abs(state.x-c.x), dy=Math.abs(state.y-c.y); state.x=c.x; state.y=c.y; renderMap(); if(drain){ addFood(-Math.ceil((dx+dy)/6)); addDrink(-Math.ceil((dx+dy)/5)); fatigue(1);} syncHUD(); }

  // ---------- STATS ----------
  function heal(n){ state.hp=Math.min(100,state.hp+n);} function addFood(n){ state.food=Math.max(0,Math.min(100,state.food+n)); } function addDrink(n){ state.drink=Math.max(0,Math.min(100,state.drink+n)); } function fatigue(n){ state.hp=Math.max(0,state.hp-n);} function spend(n){ if(state.money<n) return false; state.money-=n; return true; }
  function advanceTime(mins){ for(let i=0;i<mins;i++) tickMinute(); }
  function tickMinute(){ state.minute++; if(state.minute>=1440){ state.minute=0; state.day++; log('A new day dawns over the Neon Grid.'); } if(state.minute%5===0) addFood(-1); if(state.minute%4===0) addDrink(-1); if(state.food===0||state.drink===0) state.hp=Math.max(0,state.hp-0.2); if(state.hp<=0){ log('You blacked out. Waking at your capsule with hospital debt (−50 cr).','bad'); state.hp=50; state.food=40; state.drink=40; state.money=Math.max(0,state.money-50); state.x=10; state.y=13; renderMap(); } if(state.gig && state.gig.deadline){ state.gig.remaining--; if(state.gig.remaining<=0){ log('Gig expired. Fixer not happy.','bad'); state.gig=null; state.carriedCargo=false; state.stolen=false; } } }

  // ---------- QUICK + SAVE ----------
  document.getElementById('btnEat').onclick=()=>{ if(state.inv.rations<=0){ log('No rations.','warn'); return;} state.inv.rations--; addFood(+25); log('You eat a ration.'); syncHUD(); };
  document.getElementById('btnDrink').onclick=()=>{ if((state.inv.water||0)<=0){ log('No water.','warn'); return;} state.inv.water--; addDrink(+25); log('You drink water.'); syncHUD(); };
  document.getElementById('btnMed').onclick=()=>{ if(state.inv.medkit<=0){ log('No medkits.','warn'); return;} state.inv.medkit--; heal(35); log('Medkit applied.'); syncHUD(); };
  document.getElementById('btnSave').onclick=()=>{ localStorage.setItem('neonGridSave', JSON.stringify({state,currentSector})); log('Game saved.'); };
  document.getElementById('btnLoad').onclick=()=>{ const s=localStorage.getItem('neonGridSave'); if(!s){ log('No save found.','warn'); return;} const obj=JSON.parse(s); Object.assign(state,obj.state); currentSector=obj.currentSector||'A'; map=SECTORS[currentSector].build(); renderMap(); syncHUD(); log('Save loaded.'); };

  // ---------- OLD STATION MINIGAME ----------
  function startOldStation(){ const box=document.createElement('div'); box.className='item'; let stage='pipes'; let picks=[]; const order=['Fuel','Power']; const shuffled=[...order].sort(()=>Math.random()-0.5);
    function render(){ box.innerHTML=''; if(stage==='pipes'){ box.innerHTML+='<div><b>Connect pipes</b> — choose order: Fuel then Power</div>'; shuffled.forEach(name=>{ const b=document.createElement('button'); b.className='btn'; b.textContent=name; b.onclick=()=>{ picks.push(name); b.disabled=true; if(picks.length===2){ if(picks[0]==='Fuel'&&picks[1]==='Power'){ stage='hack'; render(); } else { box.innerHTML+='<div class="meta">Wrong connections. Try again.</div>'; picks=[]; const btns=box.querySelectorAll('button'); btns.forEach(bt=>bt.disabled=false); } } }; box.appendChild(b); }); }
      else if(stage==='hack'){ box.innerHTML+='<div><b>Hack AV</b> — hold to 100%</div>'; const prog=document.createElement('div'); prog.className='meta'; prog.textContent='Progress: 0%'; box.appendChild(prog); const hold=document.createElement('button'); hold.className='btn'; hold.textContent='Hold to hack'; let p=0,int=null; hold.onmousedown=()=>{ int=setInterval(()=>{ p+=5; prog.textContent='Progress: '+p+'%'; if(p>=100){ clearInterval(int); stage='choose'; render(); } },120); }; hold.onmouseup=()=> clearInterval(int); box.appendChild(hold); }
      else { box.innerHTML+='<div>Select sector</div>'; ['A','B'].filter(s=>s!==currentSector).forEach(s=>{ const b=document.createElement('button'); b.className='btn'; b.textContent='Jump to '+SECTORS[s].name; b.onclick=()=>{ switchSector(s); document.getElementById('locActions').innerHTML=''; log('Unsecure jump complete.'); }; box.appendChild(b); }); }
    }
    render(); locActions.appendChild(box);
  }

  function switchSector(key){ currentSector=key; map=SECTORS[currentSector].build(); const gate=findFirst(map,t=>t.type==='gate')||findFirst(map,t=>t.type==='road'); if(gate){ state.x=gate.x+1; state.y=gate.y; } renderMap(); syncHUD(); }
  function findFirst(m,pred){ for(let y=0;y<H;y++) for(let x=0;x<W;x++){ if(pred(m[y][x])) return m[y][x]; } return null; }

  // ---------- GIG DELIVERY HOOK ----------
  function maybeShowGigDelivery(c){ if(state.gig && state.carriedCargo && !state.stolen && c.x===state.gig.drop.x && c.y===state.gig.drop.y && currentSector===(state.gig.drop.sector||currentSector)){ addAction('Deliver cargo', `+${state.gig.pay} cr, +20 XP`, ()=>{ state.carriedCargo=false; state.money+=state.gig.pay; state.xp+=20; state.gig=null; log('Delivered cargo. Fixer satisfied.'); syncHUD(); menuPanel.innerHTML=''; selectLocation(c); }); } }

  // ---------- INIT ----------
  function init(){ renderMap(); syncHUD(); selectLocation(map[state.y][state.x]); log('Stable build + Offices loaded.'); }
  init();
  </script>
</body>
</html>
